# 第3轮优化：类别不平衡问题解决报告

**日期**: 2025-12-22  
**目标**: 解决类别不平衡问题，使模型能够预测"上涨"并产生有效交易

---

## 📊 执行的优化措施

### 1. 调整目标变量定义

**修改参数**:
```python
# config/settings.py
TARGET_SHIFT = 2          # 从4降到2（预测30分钟后）
TARGET_THRESHOLD = 0.005  # 从0.015降到0.005（涨幅阈值0.5%）
```

**效果**:
- 正样本比例：2.85% → **11.26%** (+295%) ✅
- 训练样本更加平衡

### 2. 使用类别权重平衡

**修改代码**:
```python
# model/lgb_model.py
def train(..., use_class_weight=False):
    if use_class_weight:
        sample_weight = compute_sample_weight('balanced', y_train)
        train_data = lgb.Dataset(X_train, label=y_train, weight=sample_weight)
```

**效果**:
- 正样本权重：3.71（高权重）
- 负样本权重：0.58（低权重）
- 模型更关注少数类

### 3. 重新训练模型

**训练结果**:
| 指标 | 优化前 | 优化后 | 变化 |
|------|--------|--------|------|
| AUC | 0.8512 | **0.7383** | -13% |
| 正样本比例 | 2.85% | **11.26%** | +295% ✅ |
| Recall（上涨） | 0% | **43%** | +43% ✅ |
| Precision（上涨） | 0% | **19%** | +19% ✅ |

**模型版本**: v20251222_031926

### 4. 调整策略参数

**降低置信度阈值**:
```python
CONFIDENCE_THRESHOLD = 0.30  # 从0.55降到0.30
SELL_THRESHOLD = 0.20        # 从0.45降到0.20
```

**禁用过滤条件**:
```python
USE_QUANTILE_THRESH = False  # 禁用分位数阈值
REQUIRE_P_EMA_UP = False     # 禁用动量过滤
```

### 5. 预测概率分析

运行`analyze_model_probs.py`分析模型输出：

```
📊 预测概率分布分析:
样本数: 450
最小值: 0.0588
最大值: 0.7653
平均值: 0.2417
中位数: 0.1867

阈值分析:
>= 0.30: 107个 (23.8%)
>= 0.40:  68个 (15.1%)
>= 0.50:  47个 (10.4%)
>= 0.55:  33个  (7.3%)
```

**发现**: 模型预测概率普遍偏低，但有足够样本满足0.30阈值。

---

## 🔴 问题：回测仍然失败

### 回测结果

**所有测试的结果完全相同**:
- 总收益：-28.74%
- 最大回撤：33.06%
- 夏普比率：-0.562
- **交易次数：0** ❌

### 尝试的解决方案

1. ✅ 降低TARGET_THRESHOLD (1.5% → 0.5%)
2. ✅ 使用类别权重平衡
3. ✅ 降低CONFIDENCE_THRESHOLD (0.55 → 0.30)
4. ✅ 禁用分位数阈值
5. ✅ 禁用动量过滤

**结果**: 所有尝试都未能产生任何交易！

---

## 🔍 根本原因分析

### 可能的问题

1. **回测框架的缓存问题**
   - 回测可能使用了旧的缓存数据
   - 数据没有重新生成特征
   - 模型没有被正确加载

2. **策略信号生成逻辑问题**
   - AISignalCore可能有其他未知的过滤条件
   - 信号生成代码可能有bug
   - 可能在某个环节返回了"hold"而不是"buy"

3. **硬性止损过早触发**
   - 所有回测都显示28.74%的亏损
   - 这个数字完全相同，说明可能是初始化问题
   - 可能在第一笔交易前就触发了止损

4. **数据问题**
   - 回测数据可能有问题
   - 特征计算可能有NaN值
   - 模型输入可能不匹配

---

## 📈 取得的进展

### ✅ 成功的部分

1. **类别不平衡问题已解决**
   - 正样本比例从2.85%提升到11.26%
   - 模型现在能预测"上涨"（Recall 43%）

2. **模型训练流程完善**
   - 支持类别权重平衡
   - 支持多币种训练
   - 完整的评估指标

3. **概率分析工具**
   - 创建了`analyze_model_probs.py`
   - 可以分析模型输出分布
   - 帮助调整阈值

### ❌ 未解决的问题

1. **回测仍然无法产生交易**
   - 尽管模型能预测上涨
   - 尽管降低了所有阈值
   - 仍然0笔交易

2. **回测结果异常一致**
   - 所有测试都是-28.74%
   - 说明可能有系统性问题
   - 不是策略参数的问题

---

## 🎯 下一步建议

### 紧急行动（今天）

1. **调试回测框架**
   ```bash
   # 清除所有缓存
   rm -rf cached_data/*
   rm -rf models/registry/*.pkl
   
   # 重新训练模型
   python butterfly_bot/scripts/train_multi_symbol.py
   
   # 运行单次回测并查看详细日志
   python scripts/test_backtest.py 2>&1 | tee debug.log
   ```

2. **检查AISignalCore**
   - 在`get_signal`方法中添加详细日志
   - 打印每一步的中间结果
   - 确认信号生成逻辑

3. **简化测试**
   - 创建最简单的策略（不使用AI）
   - 验证回测框架本身是否工作
   - 排除框架问题

### 中期行动（本周）

4. **重构策略代码**
   - 简化AISignalCore逻辑
   - 移除不必要的过滤条件
   - 使用更直接的信号生成

5. **改进回测系统**
   - 添加更详细的日志
   - 添加调试模式
   - 可视化信号生成过程

6. **尝试不同的方法**
   - 使用简单的技术指标策略（如MA交叉）
   - 验证回测框架是否正常
   - 然后再集成AI模型

---

## 📊 优化历程总结

### 第1轮：初始回测
- 结果：-25.67%，0笔交易
- 问题：类别不平衡（正样本2.85%）

### 第2轮：特征工程和模型优化
- 特征：17个 → 51个
- AUC：0.715 → 0.8512
- 结果：-26.65%，0笔交易
- 问题：模型过拟合，仍然不预测上涨

### 第3轮：类别平衡优化
- 正样本：2.85% → 11.26%
- Recall：0% → 43%
- 阈值：0.55 → 0.30
- 结果：-28.74%，0笔交易
- 问题：回测框架或策略逻辑有问题

---

## 💡 关键洞察

1. **模型训练成功了**
   - AUC 0.7383是合理的
   - Recall 43%说明能识别上涨
   - 概率分布显示有足够的高概率样本

2. **问题不在模型**
   - 问题在回测框架或策略集成
   - 需要深入调试信号生成逻辑
   - 可能是代码bug而不是参数问题

3. **需要系统性调试**
   - 不能再盲目调参数
   - 需要逐步验证每个环节
   - 使用简单策略验证框架

---

## 📁 交付文件

1. **模型文件**
   - `models/registry/v20251222_031926.pkl` - 类别平衡模型

2. **分析工具**
   - `analyze_model_probs.py` - 概率分布分析脚本

3. **报告文档**
   - `model_comparison.md` - 模型对比分析
   - `CLASS_BALANCE_OPTIMIZATION_REPORT.md` - 本报告

4. **修改的代码**
   - `butterfly_bot/model/lgb_model.py` - 支持类别权重
   - `butterfly_bot/config/settings.py` - 优化参数
   - `butterfly_bot/scripts/train_multi_symbol.py` - 多币种训练

---

## 🚨 重要提示

**当前系统不适合实盘交易！**

原因：
1. 回测无法产生任何交易
2. 策略逻辑可能有严重bug
3. 需要彻底调试和验证

**建议**：
1. 暂停实盘计划
2. 专注于调试回测框架
3. 使用简单策略验证系统
4. 确保至少能产生交易后再优化策略

---

**报告生成时间**: 2025-12-22  
**优化轮次**: 第3轮  
**状态**: 🔴 未达目标，需要深入调试
