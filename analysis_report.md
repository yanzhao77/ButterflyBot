# ButterflyBot 亏损原因分析报告

## 一、项目概况

ButterflyBot 是一个基于 AI 的加密货币量化交易系统，采用 LightGBM + Prophet + 规则引擎的融合模型进行交易决策。

**核心配置：**
- 交易对: DOGE/USDT
- 时间周期: 15m
- 初始资金: 1000 USDT
- 最大仓位比例: 30%
- 止损: 0.8%
- 止盈: 1%

## 二、识别的主要问题

### 1. **过于激进的交易阈值**

当前配置中的买入阈值和卖出阈值过低：
- `CONFIDENCE_THRESHOLD = 0.47` (买入阈值)
- `SELL_THRESHOLD = 0.45` (卖出阈值)

**问题分析：**
- 阈值过低导致频繁交易，增加手续费成本
- 0.47 的置信度意味着模型只需要略微倾向于看涨就会开仓
- 买卖阈值差距仅 0.02，容易造成频繁进出
- 在震荡行情中会产生大量无效交易

### 2. **止盈止损比例不合理**

- 止损: 0.8% (`STOP_LOSS_PCT = 0.008`)
- 止盈: 1% (`TAKE_PROFIT_PCT = 0.01`)

**问题分析：**
- 止盈止损比例仅为 1.25:1，盈亏比过低
- 在考虑手续费（通常 0.1%-0.2%）后，实际盈亏比更差
- 止损过紧，容易被市场正常波动触发
- DOGE 这类高波动币种，0.8% 的止损几乎必然被触发

### 3. **目标定义问题**

```python
TARGET_SHIFT = 2  # 预测未来 2 根 K 线
TARGET_THRESHOLD = 0.012  # 1.2% 涨幅阈值
```

**问题分析：**
- 15 分钟周期下，预测未来 30 分钟涨幅 1.2% 的难度极高
- 这个目标过于短期和激进，模型很难准确预测
- 训练数据中满足条件的样本可能极少，导致样本不平衡
- 实际交易中，即使达到 1.2% 涨幅，也可能因止损过紧而提前离场

### 4. **时间止损过短**

```python
TIME_STOP_BARS = 20  # 持仓超过 20 根 K 线（5 小时）强制平仓
```

**问题分析：**
- 15 分钟周期，20 根 K 线仅为 5 小时
- 加密货币市场趋势往往需要更长时间展开
- 过短的持仓时间限制了盈利空间
- 可能在趋势刚刚启动时就被迫平仓

### 5. **冷却期设置不当**

```python
COOLDOWN_BARS = 8  # 平仓后冷却 8 根 K 线（2 小时）
```

**问题分析：**
- 冷却期过长可能错过快速反转机会
- 冷却期过短可能导致在同一震荡区间反复交易
- 当前设置在震荡市中容易造成连续亏损

### 6. **分位数阈值配置**

```python
USE_QUANTILE_THRESH = True
PROB_Q_HIGH = 0.8  # 买入触发的高分位
PROB_Q_LOW = 0.5   # 卖出触发的低分位
PROB_WINDOW = 200  # 分位数计算窗口
```

**问题分析：**
- 0.8 分位数阈值过高，导致交易机会过少
- 但实际代码中仍然使用固定阈值作为兜底，导致逻辑混乱
- 分位数窗口 200 在数据不足时无法正常工作

### 7. **手续费影响被低估**

回测代码中的手续费计算：
```python
commission_rate = 0.001  # 默认 0.1%
```

**问题分析：**
- 实际交易所手续费通常为 0.1%-0.2%（买卖双向）
- 频繁交易下，手续费累积惊人
- 以当前配置，每次完整交易（买入+卖出）至少损失 0.2%
- 要实现盈利，每次交易必须至少获利 0.2% 才能覆盖成本

### 8. **数据获取问题**

代码中存在网络请求失败的问题：
- 需要代理访问 Binance API
- 缓存机制存在但可能数据陈旧
- 训练数据窗口过长（1095 天）导致请求超时

## 三、综合诊断

**核心问题：** 策略设计过于短线化，追求高频交易，但盈亏比和胜率都不足以支撑盈利。

**亏损机制：**
1. 低阈值 → 频繁开仓
2. 紧止损 → 容易被扫
3. 低止盈 → 盈利空间小
4. 高手续费 → 侵蚀利润
5. 短持仓 → 无法捕捉趋势

**数学期望分析：**
假设胜率 50%，平均盈利 1%，平均亏损 0.8%，手续费 0.2%：
- 单次盈利：1% - 0.2% = 0.8%
- 单次亏损：0.8% + 0.2% = 1%
- 期望收益：0.5 × 0.8% + 0.5 × (-1%) = -0.1%

**结论：** 即使胜率达到 50%，期望收益仍为负值。

## 四、优化方向

### 优先级 1：调整核心参数
1. 提高买入阈值至 0.65-0.70
2. 降低卖出阈值至 0.35-0.40
3. 放宽止损至 2-3%
4. 提高止盈至 4-6%
5. 延长持仓时间至 40-60 根 K 线

### 优先级 2：优化目标定义
1. 将 TARGET_SHIFT 增加至 5-10 根 K 线
2. 将 TARGET_THRESHOLD 调整至 2-3%
3. 重新训练模型

### 优先级 3：改进交易逻辑
1. 添加趋势过滤器（只在明确趋势中交易）
2. 实现动态止盈（跟踪止盈）
3. 优化冷却期机制
4. 减少交易频率

### 优先级 4：风险管理
1. 实现最大回撤控制
2. 添加连续亏损保护
3. 实现仓位动态调整
