# ButterflyBot 优化方案

## 优化策略概述

基于对当前策略的深入分析，我们将采用**多层次优化方案**，从参数调整、目标重定义、交易逻辑改进三个维度进行优化。

## 方案一：保守型优化（推荐）

### 目标
降低交易频率，提高盈亏比，追求稳定盈利。

### 核心改动

#### 1. 交易阈值调整
```python
CONFIDENCE_THRESHOLD = 0.68  # 从 0.47 提升至 0.68
SELL_THRESHOLD = 0.38        # 从 0.45 降低至 0.38
```
**理由：**
- 更大的阈值差距（0.30）减少震荡市中的无效交易
- 只在模型高度确信时才开仓
- 降低交易频率，减少手续费损耗

#### 2. 止盈止损优化
```python
STOP_LOSS_PCT = 0.025   # 从 0.008 放宽至 0.025 (2.5%)
TAKE_PROFIT_PCT = 0.05  # 从 0.01 提升至 0.05 (5%)
```
**理由：**
- 盈亏比从 1.25:1 提升至 2:1
- 2.5% 止损可以容忍正常市场波动
- 5% 止盈给予趋势充分发展空间
- 考虑手续费后，期望收益转正

#### 3. 持仓时间延长
```python
TIME_STOP_BARS = 50  # 从 20 延长至 50 (12.5 小时)
```
**理由：**
- 给予趋势更多时间发展
- 减少过早离场导致的机会损失
- 配合更宽的止盈目标

#### 4. 冷却期优化
```python
COOLDOWN_BARS = 5  # 从 8 缩短至 5 (75 分钟)
```
**理由：**
- 在高阈值下，交易频率已经降低
- 适度缩短冷却期以捕捉快速反转
- 平衡过度交易和错失机会

#### 5. 目标定义重构
```python
TARGET_SHIFT = 8        # 从 2 增加至 8 (2 小时)
TARGET_THRESHOLD = 0.03 # 从 0.012 增加至 0.03 (3%)
```
**理由：**
- 预测更长时间窗口，降低噪音影响
- 3% 的目标更符合实际止盈设置
- 提高模型训练的样本质量

#### 6. 分位数阈值调整
```python
USE_QUANTILE_THRESH = True
PROB_Q_HIGH = 0.85  # 从 0.8 提升至 0.85
PROB_Q_LOW = 0.40   # 从 0.5 降低至 0.40
PROB_WINDOW = 300   # 从 200 增加至 300
```
**理由：**
- 更严格的买入条件
- 更宽松的卖出条件（避免过早离场）
- 更大的窗口提供更稳定的分位数估计

#### 7. 仓位管理优化
```python
MAX_POSITION_RATIO = 0.25  # 从 0.3 降低至 0.25
```
**理由：**
- 降低单次交易风险敞口
- 保留更多现金应对不利情况
- 提高资金使用效率

#### 8. 训练数据优化
```python
RETRAIN_SINCE_DAYS = 365  # 从 1095 降低至 365
```
**理由：**
- 减少数据获取时间和失败概率
- 更关注近期市场特征
- 提高训练速度

## 方案二：激进型优化

### 目标
在保守方案基础上，进一步提高盈亏比，追求更高收益。

### 核心改动
```python
CONFIDENCE_THRESHOLD = 0.75
SELL_THRESHOLD = 0.35
STOP_LOSS_PCT = 0.03
TAKE_PROFIT_PCT = 0.08
TIME_STOP_BARS = 80
MAX_POSITION_RATIO = 0.20
TARGET_SHIFT = 12
TARGET_THRESHOLD = 0.05
```

**特点：**
- 交易频率更低
- 盈亏比更高（2.67:1）
- 只捕捉高确定性机会
- 适合趋势明显的市场

## 方案三：动态止盈优化

### 新增功能：跟踪止盈

在保守方案基础上，添加动态止盈机制：

```python
# 新增配置
USE_TRAILING_STOP = True
TRAILING_STOP_ACTIVATION = 0.03  # 盈利达到 3% 后启动跟踪
TRAILING_STOP_DISTANCE = 0.015   # 回撤 1.5% 时止盈
```

**逻辑：**
1. 持仓盈利达到 3% 时，启动跟踪止盈
2. 记录最高价格
3. 当价格从最高点回撤 1.5% 时，触发止盈
4. 允许利润奔跑，同时锁定大部分收益

## 方案四：趋势过滤增强

### 新增功能：多重趋势确认

```python
# 新增配置
REQUIRE_TREND_ALIGN = True
MIN_TREND_STRENGTH = 0.02  # 最小趋势强度（MA 差距）
```

**逻辑：**
1. 买入前检查：价格 > MA20 > MA50
2. MA20 与 MA50 差距至少 2%
3. 确保在明确上升趋势中交易
4. 避免震荡市中的虚假信号

## 实施步骤

### 第一步：参数优化（立即执行）
修改 `config/settings.py`，应用保守型优化参数。

### 第二步：代码增强（可选）
1. 实现跟踪止盈功能
2. 添加趋势过滤器
3. 实现连续亏损保护

### 第三步：模型重训练
使用新的目标定义重新训练模型。

### 第四步：回测验证
运行回测，验证优化效果。

### 第五步：参数微调
根据回测结果进行细微调整。

## 预期效果

### 保守方案预期
- 交易频率：降低 60-70%
- 胜率：提升至 45-55%
- 盈亏比：2:1
- 期望收益：转正
- 最大回撤：控制在 15% 以内

### 数学期望分析（保守方案）
假设：
- 胜率：50%
- 平均盈利：5%
- 平均亏损：2.5%
- 手续费：0.2%

计算：
- 单次盈利：5% - 0.2% = 4.8%
- 单次亏损：2.5% + 0.2% = 2.7%
- 期望收益：0.5 × 4.8% + 0.5 × (-2.7%) = 1.05%

**结论：** 期望收益为正，具备盈利基础。

## 风险提示

1. **市场环境依赖**：策略在趋势市表现更好，震荡市可能仍然亏损
2. **样本外表现**：回测盈利不代表实盘必然盈利
3. **滑点影响**：实盘交易存在滑点，会降低实际收益
4. **极端行情**：黑天鹅事件可能导致超出止损的损失

## 建议

1. **先应用保守方案**，验证效果后再考虑激进方案
2. **小资金测试**，确认盈利后再增加投入
3. **持续监控**，定期评估策略表现
4. **动态调整**，根据市场变化优化参数
